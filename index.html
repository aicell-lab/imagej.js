<!DOCTYPE html>
<html lang="en">
<head>
<title>ImageJ.JS</title>
<script src="https://cjrtnc.leaningtech.com/4.0/loader.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
    html,
    body {
      margin: 0;
    }
  
    #container {
      width: 100vw;
      height: 100svh;
    }
  </style>
</head>

<body>
<!-- Native File System Button -->
<div class="fixed bottom-4 left-4 z-50">
  <button id="loadFolderBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors duration-200 flex items-center space-x-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-5l-2-2H5a2 2 0 00-2 2z"></path>
    </svg>
    <span>Load Folder</span>
  </button>
</div>

<!-- Status indicator -->
<div id="folderStatus" class="fixed bottom-4 left-4 z-40 bg-green-600 text-white px-3 py-1 rounded-md shadow-lg hidden">
  <span id="folderName"></span> loaded
</div>

<!-- Load utilities -->
<script src="utils.js"></script>

<script type="module">
const baseUrl = location.pathname === "/" ? "/" : location.pathname;
function patchDownloader(){
  // Original DirectDownloader patch
  function ddlSend()
  {
      var downloader = this;
      var headers = {};
      var method = "GET";
      if(downloader.rangeHeader)
          headers["Range"] = downloader.rangeHeader;
      else if(downloader.metaDataOnly)
          headers["Range"] = "bytes=0-0";
      if(this.url.startsWith(`${baseUrl}lib/ImageJ/samples/`)){
          this.url = this.url.replace(`${baseUrl}lib/ImageJ/samples/`, 'https://imagej.net/images/');
      }
      fetch(downloader.url, {"method": method, "mode": "cors", "headers" : headers})
          .then(function(response){
              ddlOnLoad(response, downloader);
          })
          .catch(function(err){
              ddlOnError(downloader, err);
          });
  }

  // Apply DirectDownloader patch
  DirectDownloader.prototype.send = ddlSend;
}

async function applyPatches(){
    patchDownloader();
    // Apply native file system patches from utils.js
    createNativeFileSystemPatches();
}

// Event listener for the load folder button
document.addEventListener('DOMContentLoaded', () => {
    const loadFolderBtn = document.getElementById('loadFolderBtn');
    loadFolderBtn.addEventListener('click', () => {
        // Use the nativeFS instance from utils.js
        window.nativeFS.loadDirectory();
    });
});

await cheerpjInit({
    clipboardMode: "java", // "permission" | "system" | "java"
    javaProperties: [
      "user.dir=/files",
      `plugins.dir=/app${baseUrl}lib/ImageJ/plugins`,
      "useJFileChooser=true"
    ],
});
await applyPatches();
cheerpjCreateDisplay(-1, -1, document.getElementById("container"));
await cheerpjRunJar(`/app${baseUrl}lib/ImageJ/ij.jar`);
 
</script>
<div id="container"></div>
</body>
</html>